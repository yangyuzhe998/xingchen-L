============================= test session starts =============================
platform win32 -- Python 3.10.0, pytest-8.3.5, pluggy-1.5.0 -- C:\Users\13495\AppData\Local\Programs\Python\Python310\python.exe
cachedir: .pytest_cache
rootdir: E:\xingchen-V
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-0.25.3, requests-mock-1.12.1, typeguard-2.13.3
asyncio: mode=auto, asyncio_default_fixture_loop_scope=function
collecting ... 2026-02-07 23:36:49 - [XingChen-V] - INFO - [EventBus] 总线已连接: E:\xingchen-V\src\memory_data\bus.db
2026-02-07 23:36:49 - [XingChen-V] - INFO - [TopicManager] Initialized with {'topics': 1, 'tasks': 1, 'fragments': 0}
2026-02-07 23:36:50 - [XingChen-V] - INFO - [AutoClassifier] Initialized with deepseek LLM
2026-02-07 23:36:50 - [XingChen-V] - INFO - [MemoryOrchestrator] Initialized
collected 2 items

tests/test_memory/test_memory_orchestrator.py::TestMemoryOrchestrator::test_classify_compressed_memory_success DEBUG: test orchestrator=1661261089232
DEBUG: orchestrator.auto_classifier=<Mock id='1661463313136'>
DEBUG: classify_compressed_memory self=1661261089232
DEBUG: self.auto_classifier=<Mock id='1661463313136'>
FAILED
tests/test_memory/test_memory_orchestrator.py::TestMemoryOrchestrator::test_classify_compressed_memory_failure_retry DEBUG: classify_compressed_memory self=1661261089232
DEBUG: self.auto_classifier=<Mock id='1661463522768'>
FAILED

================================== FAILURES ===================================
_______ TestMemoryOrchestrator.test_classify_compressed_memory_success ________

self = <test_memory_orchestrator.TestMemoryOrchestrator object at 0x00000182D6EE36D0>
orchestrator = <src.memory.services.memory_orchestrator.MemoryOrchestrator object at 0x00000182CAE089D0>

    def test_classify_compressed_memory_success(self, orchestrator):
        """测试分类成功"""
        script = "User: Hello\nAI: Hi"
    
        print(f"DEBUG: test orchestrator={id(orchestrator)}")
        print(f"DEBUG: orchestrator.auto_classifier={orchestrator.auto_classifier}")
    
        # 直接 Mock 实例属性
        orchestrator.auto_classifier.classify_and_store.return_value = "frag_123"
    
        result = orchestrator.classify_compressed_memory(script)
    
>       assert result["success"] == 1
E       assert 0 == 1

tests\test_memory\test_memory_orchestrator.py:43: AssertionError
____ TestMemoryOrchestrator.test_classify_compressed_memory_failure_retry _____

self = <test_memory_orchestrator.TestMemoryOrchestrator object at 0x00000182D6EE3880>
orchestrator = <src.memory.services.memory_orchestrator.MemoryOrchestrator object at 0x00000182CAE089D0>
tmp_path = WindowsPath('C:/Users/13495/AppData/Local/Temp/pytest-of-13495/pytest-54/test_classify_compressed_memor0')

    def test_classify_compressed_memory_failure_retry(self, orchestrator, tmp_path):
        """测试分类失败并写入待处理"""
        script = "User: Error test"
        orchestrator.pending_path = str(tmp_path / "pending.json")
    
        # 第一次调用失败
        orchestrator.auto_classifier.classify_and_store.side_effect = Exception("API Error")
    
        result = orchestrator.classify_compressed_memory(script)
    
        assert result["success"] == 0
>       assert result["failed"] == 1
E       assert 0 == 1

tests\test_memory\test_memory_orchestrator.py:58: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_memory/test_memory_orchestrator.py::TestMemoryOrchestrator::test_classify_compressed_memory_success
FAILED tests/test_memory/test_memory_orchestrator.py::TestMemoryOrchestrator::test_classify_compressed_memory_failure_retry
============================== 2 failed in 3.81s ==============================
