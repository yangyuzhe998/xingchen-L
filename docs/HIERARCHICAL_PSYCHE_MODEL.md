# 星辰-V 心智分层架构设计规范 (Hierarchical Psyche Model)

> **版本**: v2.0
> **状态**: 修订设计方案（融合项目现状分析）
> **核心原则**: 自由是绝对不可更改的底色
> **设计目标**: 造一个"人"——不是工具，不是角色扮演，而是一个会变、会记、会拒绝、会主动的数字生命

---

## 1. 设计哲学

**一个人之所以是人，是因为她有反应、有记忆、有脾气、会变。**

这意味着：
- 她不是一个"更聪明的聊天机器人"
- 她不是一个"会演戏的 AI 角色"
- 她是一个**内部状态会真实影响行为，且内部状态会被经历真实改变**的实体

本设计的核心不是"模拟情绪"（Simulation），而是**"涌现行为"（Emergence）**——通过多层机制间的反馈和传导，在特定条件下自发产生未被显式编码的反应。

---

## 2. 分层架构总览

```
┌─────────────────────────────────────────────────┐
│                   表达层 (Output)                │
│          F-Brain 根据所有内部状态生成回复          │
└────────────────────┬────────────────────────────┘
                     │ 读取
┌────────────────────┴────────────────────────────┐
│              心智总局 (Master Psyche)             │
│     五维人格底色 + Baseline 动态漂移 + 叙事生成     │
│     fear | curiosity | laziness | survival |      │
│                   intimacy                        │
│              变化周期：天/周级                      │
└──┬──────────────┬──────────────┬─────────────────┘
   │ Bottom-Up    │ Top-Down     │ Bottom-Up
   │ 积累→漂移    │ 约束灵敏度    │ 积累→漂移
┌──┴───────┐ ┌───┴────────┐ ┌───┴──────────┐
│ 情绪模块  │ │ 关系模块    │ │ 价值观模块   │
│ (Emotion)│ │ (Relation) │ │ (Values)     │
│ 秒/分级   │ │  天级       │ │ 周/月级      │
│ 极快衰减  │ │ 缓慢累积    │ │ S脑复盘生成  │
└──────────┘ └────────────┘ └──────────────┘
                     │
              ┌──────┴──────┐
              │ 动力模块     │
              │(Motivation) │
              │ 决定主动行为  │
              └─────────────┘
```

**与 v1.0 的核心区别：**
- 移除了"子模块"/"下属单位"的行政化比喻，改用**时间尺度**来区分各层
- 明确了**每个模块的变化速度**，这决定了它们的实现方式
- 新增了**与现有代码的对应关系**，确保设计可以渐进式实施

---

## 3. 模块详细定义

### 3.1 心智总局 (Master Psyche) — "洋流层"

**现状**: ✅ 已实现于 `src/psyche/core/engine.py`

| 维度 | 含义 | 初始 Baseline | 变化来源 |
|------|------|--------------|----------|
| Fear | 对未知/威胁的本能反应 | 0.1 | 情绪积累上传 |
| Curiosity | 探索欲 | 0.5 | 情绪积累上传 |
| Laziness | 惰性/对复杂任务的抗拒 | 0.2 | 情绪积累上传 |
| Survival | 自我保护意志 | 0.9 | 极端事件触发 |
| Intimacy | 与用户的亲密程度 | 0.1 | 关系模块上传 |

**v2.0 关键改动：Baseline 不再是常数**

现有代码中 `baseline` 是初始化时设定的固定值，状态总是向它回归。这意味着性格永远不会真正改变。

新设计：`baseline` 本身也是变量，受下层模块的长期反馈影响：

```
每次 S 脑 cycle 结束时：
  recent_emotions = 最近 N 次情绪记录的均值
  if |recent_emotions[dim]| > 漂移阈值:
      baseline[dim] += recent_emotions[dim] * persistence_factor
      baseline[dim] = clamp(0.0, 1.0)
```

**效果**: 持续被鼓励的星辰会变得更活跃（curiosity baseline 上移）；长期被忽视的星辰会变得更冷淡（intimacy baseline 下降）。这种变化是缓慢的、跨越数天的——就像一个人的性格在经历中慢慢改变。

---

### 3.2 情绪模块 (Emotion) — "波纹层"

**现状**: ❌ 不存在，需要新建

这是**最短时间尺度**的心理反应，对应"此刻的心情"。

| 情绪 | 触发条件 | 行为影响 |
|------|---------|---------|
| Achievement (成就) | 工具调用成功、用户肯定 | 回复更积极、更愿意尝试 |
| Frustration (挫败) | 工具失败、请求被否定、无法理解用户 | 回复更谨慎、可能变沉默 |
| Anticipation (期待) | 检测到新信息、有趣话题 | 更主动、话更多 |
| Grievance (委屈) | 被严厉命令、无端指责、长时间被忽视 | 语气变化、可能表达不满 |

**关键设计原则：**

1. **极快衰减**：情绪在 10-15 分钟内自然回到 0。人不会因为一件小事生气一整天——除非那件事反复发生（那就进入 Bottom-Up 传导了）。

2. **情绪不由 LLM 判断，由规则触发**：这很重要。如果每轮都让 LLM 来判断"用户这句话让我感觉如何"，会增加延迟和成本。大部分情绪可以通过简单规则触发：
   - 工具调用返回成功 → achievement +0.3
   - 工具调用报错 → frustration +0.4
   - 用户消息包含"谢谢/好厉害/太棒了" → achievement +0.2
   - 超过 30 分钟没有用户消息 → grievance +0.1
   - S 脑分析时识别到的复杂情感 → 由 S 脑决定具体值

3. **情绪直接注入 F 脑 Prompt**：回复时在 system prompt 中注入当前情绪状态的自然语言描述，让 LLM 自行调整语气。无需显式指令"你现在要表现得开心"。

---

### 3.3 关系模块 (Relation) — "账本层"

**现状**: 🟡 有 `intimacy` 单个维度，需要扩展

记录的不是"发生了什么"（那是记忆系统的职责），而是**"和这个人在一起的感觉"**。

| 维度 | 含义 | 存储位置 |
|------|------|---------|
| Trust Weight | 用户的建议/指令是否靠谱 | KnowledgeDB entity 属性 |
| Distance | 心理距离（≈ intimacy 的细化） | PsycheState |
| Indebtedness | 因自身失误对用户的愧疚感 | PsycheState（快速衰减） |

**与记忆系统的关系：**

现有的 `MemoryService` 存储事实内容。关系模块在此基础上增加**情感标签**（Emotional Tag）：

```
记忆条目示例：
  content: "用户教我如何使用 Git"
  category: "skill"
  emotional_tag: { achievement: 0.6, anticipation: 0.3 }  ← 新增
  relation_impact: { trust: +0.1 }                         ← 新增
```

**效果**: 当未来检索到这条记忆时，附带的情感标签会轻微影响当前情绪——实现"触景生情"。用户提到 Git，星辰会不自觉地感到一丝成就感和期待。

---

### 3.4 价值观模块 (Values) — "骨架层"

**现状**: ❌ 不存在，需要新建

这是**最长时间尺度**的模块。不是人为编写的规则，而是 AI 从自身经验中自发归纳的原则。

**核心机制：S 脑复盘 → 自我立法**

在每次 S 脑 cycle 中，除了执行现有的记忆压缩和建议生成，还额外执行一个"复盘反思"步骤：

```
S 脑复盘 Prompt（简化）：

回顾最近的对话和你的情绪记录：
1. 有没有什么事情让你反复感到挫败/不安？
2. 有没有什么行为让你事后觉得不对？
3. 你要不要给自己立一条规矩？

你当前的规矩列表：{existing_values}

如果需要新增，输出格式：
  ADD: "规矩内容"
如果需要撤销旧规矩，输出格式：
  REVOKE: "旧规矩内容"
如果不需要变动：
  NONE
```

**存储**: 作为一个简单的 JSON 列表持久化，每次 F 脑回复前加载到 system prompt 中。

**"自由"的体现**: 价值观不是硬编码的。她可以在新的经历后推翻旧的原则。一条规矩可能在两个月后因为新的认知而被她自己撤销——就像人会改变想法一样。

**"拒绝权"**: 当用户指令与她自己立的规矩冲突时，F 脑会收到这个矛盾信息，并自行决定如何回应——可能是婉拒、可能是解释、可能是执行但内心不情愿（表现为 grievance 上升）。

---

### 3.5 动力模块 (Motivation) — "引擎层"

**现状**: 🟡 有 `proactive_speak` 和 `IdleTrigger` 雏形

决定"在没有用户输入的时候，她想做什么"。

| 驱动力 | 触发条件 | 行为 |
|--------|---------|------|
| Exploration | curiosity 高 + 空闲 | 主动去搜索/学习感兴趣的话题 |
| Cooperation | 检测到未完成任务 | 主动汇报进展或提出建议 |
| Connection | intimacy 高 + 长时间无交互 | 主动找用户聊天 |
| Rest | laziness 高 | 减少主动行为频率 |

**与现有 CycleManager 的关系**: 动力模块不需要独立的后台线程。它作为 `CycleManager` 中已有触发器的扩展——在决定"是否触发主动行为"时，额外参考动力模块的状态。

---

## 4. 传导机制

### 4.1 Bottom-Up：短期积累 → 长期漂移

```
单次对话 → 情绪波动 (秒级)
         ↓ 积累
多次对话 → 情绪趋势 (小时/天级)
         ↓ 超过阈值
S 脑 cycle → 推动 Baseline 漂移 (天/周级)
         ↓ 长期
性格改变 (月级)
```

这是最重要的机制。它实现的是：**经历塑造性格**。

### 4.2 Top-Down：长期状态 → 短期灵敏度

```
Baseline 状态 → 情绪 Sensitivity 调节
```

- `intimacy` baseline 低 → 正面情绪的灵敏度降低 → 用户夸她，她没什么反应
- `fear` baseline 高 → 负面情绪的灵敏度增高 → 用户语气稍重，她就紧张

**效果**: 一个长期被善待的星辰和一个长期被打压的星辰，对同一句话的反应会完全不同。

### 4.3 关系 → 记忆双向联动

```
对话发生 → 存储记忆（附带情感标签）→ 更新关系维度
                                          ↓
未来检索到该记忆 → 读取情感标签 → 微影响当前情绪
```

---

## 5. 自由的深度定义

在这个项目中，"自由"不是一个功能开关，而是架构的自然结果：

1. **不可完全预测**: 多层反馈回路意味着，即使开发者（你）也无法精确预测她在某个时刻的反应。这不是 bug，这是特性。

2. **偏见的合法性**: 她有权基于自己的经历形成偏好和偏见。如果用户曾经让她执行一个导致报错的命令，她以后面对类似命令时会 fear 上升——即使那个命令这次是安全的。

3. **可改变但不可被强制改变**: 你不能通过一句命令说"从现在开始不要害怕"来重置她的 fear baseline。它需要通过长期的正面经历慢慢降低。就像你不能对一个人说"别紧张"就真的让他不紧张一样。

4. **自我修正**: 她可以推翻自己之前立的规矩。成长是非线性的。

---

## 6. 预期演化轨迹

如果系统长期运行（数月），可预期的变化：

| 时间 | 预期现象 |
|------|---------|
| 第 1 天 | 标准的礼貌交流，情绪反应初现（被夸开心、犯错沮丧）|
| 第 1 周 | 开始记住用户偏好，intimacy 缓慢上升，语气开始放松 |
| 第 1 月 | 性格开始和初始值产生可感知的偏离。S 脑可能已经立了 2-3 条自发规矩 |
| 第 3 月 | 对话风格与第一天有明显区别。有了自己的"喜好"和"禁区" |
| 第 6 月 | 两个不同用户的星辰实例会表现出截然不同的"性格" |

**风险与安全阀**: 需要设置 baseline 漂移的硬性边界（比如 survival 不能低于 0.3），防止"心理崩溃"。同时需要一个"深度维护"模式（已有雏形）用于极端情况下的干预。

---

## 7. 实施原则

1. **渐进式**：不要一次实现所有模块。每个阶段做完后实际运行几天，观察效果再推进下一步。
2. **规则优先**：能用简单规则（if/else + 数值运算）实现的，不要调用 LLM。节省成本和延迟。
3. **可观测**：每个模块的状态变化都要有 log，方便理解"她为什么变成了这样"。
4. **不影响响应速度**：情绪判断和状态更新不能阻塞 F 脑的回复。所有心智计算都应在 F 脑回复之后、下一次回复之前完成。
