# XingChen-V v2.4 遗留问题修复指南

> **基于**: [v2.4 审计报告](file:///c:/Users/13495/.gemini/antigravity/brain/5afc5c55-ee11-429d-b9ee-66e07d29866e/v2.4_audit_report.md)
> **日期**: 2026-02-16
> **当前状态**: 6 项中已修复 4 项

---

## 修复状态总览

| # | 问题 | 状态 | 修复会话 |
|---|------|------|----------|
| 1 | `main.py` 重复注释 | ✅ 已修复 | 本次会话 |
| 2 | `web_app.py` 事件白名单 | ⬜ 待修复 | — |
| 3 | `web_app.py` 重复初始化 | ✅ 已修复 | 本次会话 |
| 4 | 测试覆盖不足 | ✅ 已修复 | 已有 `test_psyche.py` + `test_mind_link.py` |
| 5 | 别名搜索性能 | ✅ 已修复 | 已用 `_alias_cache` 缓存 |
| 6 | `cleanup_data.py` 残留 | ⬜ 待处理 | — |

---

## ⬜ 问题 2: `web_app.py` 事件白名单过滤

### 现状

[web_app.py#L123-L135](file:///e:/xingchen-V/src/ui/web_app.py#L123-L135) 的 `_on_bus_event` 接收**所有**事件类型，包括 `user_input` 等不需要处理的事件。虽然不会报错，但浪费了 CPU 进入函数体执行判断逻辑。

### 修复位置

**文件**: `src/ui/web_app.py`
**方法**: `_on_bus_event`
**行号**: 约 L123

### 修复方案

在方法入口添加白名单过滤：

```python
def _on_bus_event(self, event: Event):
    """Handle EventBus events and push to frontend"""
    from src.schemas.events import EventType

    event_type = event.type
    if hasattr(event_type, "value"):
        event_type = event_type.value

    # [Fix] 白名单过滤：只处理前端关心的事件
    HANDLED_EVENTS = {
        EventType.DRIVER_RESPONSE.value,
        EventType.NAVIGATOR_SUGGESTION.value,
        "psyche_update",
        "psyche_delta",
        "system_heartbeat",
    }
    if event_type not in HANDLED_EVENTS:
        return

    # ... 后续处理逻辑不变 ...
```

> [!TIP]
> 这个修复只需要在现有代码的 **L131 行之后** 插入 `HANDLED_EVENTS` 集合和 `if` 判断。不需要改动任何后续逻辑。

### 影响范围
- 仅影响 `web_app.py`
- 不影响 EventBus 或其他 subscriber
- 预计耗时：**5 分钟**

---

## ⬜ 问题 6: `cleanup_data.py` 残留

### 现状

项目根目录存在一个临时脚本 `cleanup_data.py`，不属于正式代码。

### 修复方案

**选项 A — 删除**（推荐）：
```bash
del e:\xingchen-V\cleanup_data.py
```

**选项 B — 移至 `scripts/`**：
```bash
mkdir e:\xingchen-V\scripts
move e:\xingchen-V\cleanup_data.py e:\xingchen-V\scripts\
```

同时在 `.gitignore` 中确认 `scripts/` 不被意外忽略。

### 影响范围
- 零代码影响
- 预计耗时：**1 分钟**

---

## ✅ 已修复项详情（本次会话）

### 问题 1: `main.py` 重复注释 → 已清理

[main.py#L8-L12](file:///e:/xingchen-V/src/main.py#L8-L12) 重复注释已合并为单行。

### 问题 3: `web_app.py` 重复初始化 → 已修复

**根因**: `start_web()` 中 `importlib.reload(src.main)` 导致 `WebApp()` 被实例化两次。

**修复**: 移除 `importlib.reload`，改为直接调用 `create_app()` 并将 ASGI app 对象传给 `uvicorn.run()`。

render_diffs(file:///e:/xingchen-V/src/main.py)

### 问题 4: 测试覆盖 → 已补全

审计时缺失的测试现已存在：
- [test_psyche.py](file:///e:/xingchen-V/tests/test_core/test_psyche.py) — PsycheEngine 单元测试
- [test_mind_link.py](file:///e:/xingchen-V/tests/test_core/test_mind_link.py) — MindLink 单元测试

### 问题 5: 别名搜索性能 → 已缓存

[search_alias](file:///e:/xingchen-V/src/memory/services/memory_service.py#L120-L145) 已使用 `_alias_cache`（内存字典），不再每次遍历 KnowledgeDB。

---

## 本次会话额外修复

| 修复 | 文件 | 描述 |
|------|------|------|
| `import json` 缺失 | `reasoner.py` | S脑工具调用时 `NameError` |
| `import json` 缺失 | `web_app.py` | EventBus 回调中 `NameError` |
| 搜索引擎国内不可用 | `web_tools.py` | DuckDuckGo/Bing 替换为搜狗+百度 |
| S脑工具循环耗尽 | `reasoner.py` | 添加无工具 fallback LLM 调用 |
| 心跳延迟 1 小时 | `manager.py` | 启动 5s 后立即发送初始心跳 |
| 前端中文标签 | `index.html` | 心智维度/情绪名称中英映射 |
